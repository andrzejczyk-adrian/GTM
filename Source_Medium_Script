<script>
/* 
Autorski skrypt poprawiający jakość ruchu. Po więcej informacji zapraszam do kontaktu:
Adrian Andrzejczyk - https://andrzejczyk.com.pl
*/
  
  // Funkcja do ustawiania ciasteczka
  function setCookie(name, value, days) {
    var expires = "";
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + (8 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/; Secure; SameSite=Lax";
  }

  // Funkcja do ustawiania LocalStorage
  function setLocalStorage(name, value) {
    if (value) {
      localStorage.setItem(name, value);
    }
  }

  // Funkcja do czyszczenia wartości z LocalStorage
  function clearLocalStorage(name) {
    localStorage.removeItem(name);
  }

  // Funkcja do wyciągania parametrów z URL
  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  // Funkcja do wyciągania wartości ciasteczka
  function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  // Funkcja do ustawiania cookies z LocalStorage
  function setLocalStorageCookies() {
    var source = localStorage.getItem('source_3');
    var medium = localStorage.getItem('medium_3');
    setCookie('source_3_local', source, 31);  // Ustawienie ciasteczka na 1 dni
    setCookie('medium_3_local', medium, 31);  // Ustawienie ciasteczka na 1 dni
  }

  // Lista wykluczonych domen
  var excludedDomainsRegex = /(?:technica\.pl|sklep\.technica\.pl|tagassistant\.google\.com|accounts.google.com|accounts.google.pl|adpanel.apaczka.pl|api.pekao24.pl|app.asana.com|app.zowie.ai|b24-1uiumn.bitrix24.pl|bankmillennium.pl|bosbank24.pl|business.facebook.com|ca24.credit-agricole.pl|centrum24.pl|citibankonline.pl|com.slack|credit.payu.com|docs.google.com|eblik.pl|euc-excel.officeapps.live.com|exchange.vuemail.com|go.przelewy24.pl|imoje-backoffice.paymento.pl|ingbank.pl|inteligo.pl|ipko.pl|kbs24.pl|kew.advisor247.pl|localhost|login.ingbank.pl|login.nestbank.pl|m.poczta.onet.pl|mail.google.com|mail.grupazpr.pl|mail.northfood.pl|mail.technica.pl|mail.volta.net.pl|mpoczta.me.pl|mtransfer.mbank.pl|officeapps.live.com|pay.bm.pl|paypal.com|paywall.imoje.pl|pekaobiznes24.pl|platnosci.pekao24.pl|plusbank24.pl|poczta.ath.bielsko.pl|poczta.diag.pl|poczta.eurozet.pl|poczta.gazeta.pl|poczta.infocity.pl|poczta.interia.pl|poczta.jadmar.com.pl|poczta.nazwa.pl|poczta.o2.pl|poczta.onet.pl|poczta.psse.malopolska.pl|poczta.technica.pl|poczta.wp.pl|search-dre.dt.dbankcloud.com|secure.getinbank.pl|secure.paylane.com|secure.payu.com|system.aliorbank.pl|tagassistant.google.com|technica.pl)/;

  // Lista wyszukiwarek z regexami
  var searchEngines = {
    'google': /.*google.*/,
    'bing': /.*bing.*/,
    'yahoo': /.*yahoo.*/
  };

  // Lista wykluczonych URL-i
  var excludedPathsRegex = /\/(koszyk|edycja-konta|some-other-path)/;

  // Główna funkcja do sprawdzania i zapisywania utm_source i utm_medium
  function checkAndStoreUTM() {
    var utmSource = getParameterByName('utm_source');
    var utmMedium = getParameterByName('utm_medium');
    var gclid = getParameterByName('gclid');
    var fbclid = getParameterByName('fbclid');
    var referrer = document.referrer;

    // Sprawdzenie czy są już ustawione ciasteczka
    var cookieSource = getCookie('source_3');
    var cookieMedium = getCookie('medium_3');

    // Funkcja do czyszczenia LocalStorage i ustawiania nowych wartości
    function clearAndSetLocalStorage(source, medium) {
      clearLocalStorage('source_3');
      clearLocalStorage('medium_3');
      setLocalStorage('source_3', source);
      setLocalStorage('medium_3', medium);
      setLocalStorageCookies();  // Ustawienie cookies z LocalStorage
    }

    if (gclid || fbclid) {
      console.log("Setting cookies and LocalStorage for gclid or fbclid");
      var source = gclid ? 'google' : 'facebook';
      setCookie('source_3', source, 31);  // Ustawienie ciasteczka na 31 dni
      setCookie('medium_3', 'cpc', 31);    // Ustawienie ciasteczka na 31 dni
      clearAndSetLocalStorage(source, 'cpc');  // Ustawienie LocalStorage
      return;
    }

    if (utmSource) {
      console.log("Setting cookies and LocalStorage for utm_source");
      setCookie('source_3', utmSource || 'none', 31);  // Ustawienie ciasteczka na 31 dni
      setCookie('medium_3', utmMedium || 'none', 31);  // Ustawienie ciasteczka na 31 dni
      clearAndSetLocalStorage(utmSource || '(none)', utmMedium || '(none)');  // Ustawienie LocalStorage
      return;
    }

    // Sprawdzanie czy referrer jest wyszukiwarką
    for (var engine in searchEngines) {
      if (searchEngines[engine].test(referrer)) {
        console.log("Setting cookies and LocalStorage for search engine referrer");
        setCookie('source_3', engine, 10);  // Ustawienie ciasteczka na 10 dni
        setCookie('medium_3', 'organic', 10);  // Ustawienie ciasteczka na 10 dni
        clearAndSetLocalStorage(engine, 'organic');  // Ustawienie LocalStorage
        return;
      }
    }

    // Sprawdzanie czy referrer jest wykluczony lub URL jest wykluczony
    if (excludedDomainsRegex.test(referrer) || excludedPathsRegex.test(referrer)) {
      console.log("Referrer or URL is excluded");
      return;
    }

    // Jeśli żadne z powyższych, ustaw ciasteczka i LocalStorage na direct i none
    if (!cookieSource && !cookieMedium) {
      console.log("Setting default cookies and LocalStorage for direct traffic");
      setCookie('source_3', '(direct)', 1);  // Ustawienie ciasteczka na 1 dni
      setCookie('medium_3', '(none)', 1);    // Ustawienie ciasteczka na 1 dni
      clearAndSetLocalStorage('(direct)', '(none)');  // Ustawienie LocalStorage
    } else {
      // Ustawienie cookies z LocalStorage jeśli istnieją już wartości
      setLocalStorageCookies();
    }
  }

  // Wywołanie głównej funkcji przy ładowaniu strony
  checkAndStoreUTM();
</script>
